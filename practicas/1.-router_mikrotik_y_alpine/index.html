
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentacióm Curso ITB Julio 2024 Documentación">
      
      
        <meta name="author" content="IsardVDI">
      
      
        <link rel="canonical" href="http://localhost:9099/practicas/1.-router_mikrotik_y_alpine/">
      
      
        <link rel="prev" href="../../instalaciones/instalacion_servidor_isardvdi/">
      
      
        <link rel="next" href="../2.-raid/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.20">
    
    
      
        <title>1. Routers con mikrotik y alpine linux - Curso_ITB</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.eebd395e.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-routers-con-mikrotik-y-alpine-linux" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="Curso_ITB" class="md-header__button md-logo" aria-label="Curso_ITB" data-md-component="logo">
      
  <img src="../../images/isard_marca_RGB_rectangular.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Curso_ITB
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              1. Routers con mikrotik y alpine linux
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://gitlab.com/isard/cursoitb" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitLab
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Curso_ITB" class="md-nav__button md-logo" aria-label="Curso_ITB" data-md-component="logo">
      
  <img src="../../images/isard_marca_RGB_rectangular.png" alt="logo">

    </a>
    Curso_ITB
  </label>
  
    <div class="md-nav__source">
      <a href="https://gitlab.com/isard/cursoitb" title="Ir al repositorio" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitLab
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Curso Virtualización de Escritorios con IsardVDI
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../recursos/" class="md-nav__link">
        Recursos
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Instalaciones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Instalaciones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../instalaciones/configuraciones_hw/" class="md-nav__link">
        Configuraciones hw
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../instalaciones/instalacion_servidor_isardvdi/" class="md-nav__link">
        Instalación de servidor de Isard all-in-one
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Practicas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Practicas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          1. Routers con mikrotik y alpine linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        1. Routers con mikrotik y alpine linux
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mikrotik-routeros-en-isard" class="md-nav__link">
    Mikrotik RouterOS en Isard
  </a>
  
    <nav class="md-nav" aria-label="Mikrotik RouterOS en Isard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crear-escritorio-con-routeros-base-clonando-el-disco-desde-fichero-de-imagen" class="md-nav__link">
    Crear escritorio con routerOS base clonando el disco desde fichero de imagen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-incial-mikrotik" class="md-nav__link">
    Config incial mikrotik
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configurar-red-interna-con-servidor-de-dhcp-y-vpn" class="md-nav__link">
    Configurar red interna con servidor de dhcp y vpn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparar-la-configuracion-del-router-como-plantilla" class="md-nav__link">
    Preparar la configuración del router como plantilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cliente-en-red-interna" class="md-nav__link">
    Cliente en red interna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usar-la-herramienta-con-entorno-grafico-winbox-para-configurar-la-mikrotik" class="md-nav__link">
    Usar la herramienta con entorno gráfico winbox para configurar la mikrotik
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#router-linux-basadao-en-alpine-linux" class="md-nav__link">
    Router linux basadao en alpine linux
  </a>
  
    <nav class="md-nav" aria-label="Router linux basadao en alpine linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crear-plantilla-de-alpine-linux" class="md-nav__link">
    Crear plantilla de alpine linux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-red-en-linux" class="md-nav__link">
    Configuración de red en linux
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2.-raid/" class="md-nav__link">
        2. Práctica de Raid
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3.-drbd/" class="md-nav__link">
        3. DRBD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4.-drbd-ha/" class="md-nav__link">
        4. DRBD HA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5.-qcows/" class="md-nav__link">
        5. Modificar cadena en qcow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6.-ova/" class="md-nav__link">
        6. Conversión de formatos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7.-clonar_ova/" class="md-nav__link">
        7. Clonar una ova o qcow en un escritorio Isard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../8.-postgres-cliente-servidor/" class="md-nav__link">
        8. Servidor de PostgreSQL compartido con alumnos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../9.-codimd/" class="md-nav__link">
        9. Codimd. Install
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Seguridad
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Seguridad
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../seguridad/aplicativo/" class="md-nav__link">
        Seguridad Aplicativo (web)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../seguridad/sistemas/" class="md-nav__link">
        Seguridad Sistemas
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mikrotik-routeros-en-isard" class="md-nav__link">
    Mikrotik RouterOS en Isard
  </a>
  
    <nav class="md-nav" aria-label="Mikrotik RouterOS en Isard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crear-escritorio-con-routeros-base-clonando-el-disco-desde-fichero-de-imagen" class="md-nav__link">
    Crear escritorio con routerOS base clonando el disco desde fichero de imagen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config-incial-mikrotik" class="md-nav__link">
    Config incial mikrotik
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configurar-red-interna-con-servidor-de-dhcp-y-vpn" class="md-nav__link">
    Configurar red interna con servidor de dhcp y vpn
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparar-la-configuracion-del-router-como-plantilla" class="md-nav__link">
    Preparar la configuración del router como plantilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cliente-en-red-interna" class="md-nav__link">
    Cliente en red interna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usar-la-herramienta-con-entorno-grafico-winbox-para-configurar-la-mikrotik" class="md-nav__link">
    Usar la herramienta con entorno gráfico winbox para configurar la mikrotik
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#router-linux-basadao-en-alpine-linux" class="md-nav__link">
    Router linux basadao en alpine linux
  </a>
  
    <nav class="md-nav" aria-label="Router linux basadao en alpine linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crear-plantilla-de-alpine-linux" class="md-nav__link">
    Crear plantilla de alpine linux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-red-en-linux" class="md-nav__link">
    Configuración de red en linux
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="1-routers-con-mikrotik-y-alpine-linux">1. Routers con mikrotik y alpine linux<a class="headerlink" href="#1-routers-con-mikrotik-y-alpine-linux" title="Permanent link">&para;</a></h1>
<p>Queremos preparar una plantilla de router mikrotik y de alpine que pueda usarse en el siguiente escenario:</p>
<div class="highlight"><pre><span></span><code>                                                         xxxx x xxx    
                                                     xxx          xx   
                                             xxxxxxxx              xx  
                  ┌───────────┐            xx                       x  
                  │ ROUTER    │           xx                        x  
                  │ defult    ├───────────xx         internet       x  
                  │ isard     │            xx                       x  
                  └─────┬─────┘              xxxxxx                 x  
                        │.1                        x xx x x x  x x x   
                        │       red default                            
     ──┬────────────────┴────────────────────────────                  
       │                        192.168.120.0/22                       
       │                                                               
  dhcp │.x.y                                                           
┌──────┴────────────┐                                                  
│    inet           │                                                  
│                   │                                                  
│  ESCRITORIO       │dhcp    red wireguard-vpn                         
│  ROUTER ISARD  vpn├───────────────────────────────────────┬────────  
│                   │.X.Y      10.2.0.0/16                  │          
│     lan1          │                                       │.0.1      
└──────┬────────────┘                               ┌───────┴────────┐ 
       │.1                                          │  FIREWALL      │ 
       │            red personal 1                  │  ISARD         │ 
    ───┴────────┬──────────────────────             └──────┬─────────┘ 
                │    192.168.88.0/24                       │           
            dhcp│.X                                        │           
         ┌──────┴──────┐                                  ┌┴┐          
         │    eth0     │                                  │V│          
         │             │                                  │P│          
         │  ESCRITORIO │                                  │N│          
         │             │                                  └┬┘          
         │  acceso     │                                   │10.0.X.Y   
         │  a internet │                        ┌──────────┴──────────┐
         │  por red    │                        │    wireguard        │
         │  personal   │                        │                     │
         │             │                        │       MI PC         │
         │ configurar  │                        │ con fichero wireguad│
         │ mikrotik    │                        │ de usuario isard    │
         └─────────────┘                        │                     │
                                                └─────────────────────┘
</code></pre></div>
<h2 id="mikrotik-routeros-en-isard">Mikrotik RouterOS en Isard<a class="headerlink" href="#mikrotik-routeros-en-isard" title="Permanent link">&para;</a></h2>
<p>Un escritorio con sistema operativo RouterOS de mikrotik que usaremos para dar acceso a internet a un escritorio que se conectará a la red personal. Este router hará nat "masquerade" hacia la red default y también tendrá un servidor dhcp. Se podrá acceder también a través de la red vpn personal para poderlo configurar desde nuestro pc. Esta configuración puede servir de base para otras prácticas más complejas de redes.</p>
<h3 id="crear-escritorio-con-routeros-base-clonando-el-disco-desde-fichero-de-imagen">Crear escritorio con routerOS base clonando el disco desde fichero de imagen<a class="headerlink" href="#crear-escritorio-con-routeros-base-clonando-el-disco-desde-fichero-de-imagen" title="Permanent link">&para;</a></h3>
<p>Creamos un desktop basado a partir de una iso de system rescue cd:</p>
<p><a class="glightbox" href="../images/mikrotik1.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="mikrotik1" src="../images/mikrotik1.png" /></a></p>
<p>Arrancamos el system rescue cd, ahora queremos entrarle por ssh para poder copiar y pegar comandos... Para eso, como no tenemos interface gráfica, lo mejor es conectarnos por ssh a ese escritorio. Para eso hemos de usar la vpn personal. Nos descargamos el fichero de vpn personal. Lo movemos a la carpeta de wireguard y le cambiamos el nombre de isard-vpn.conf a docente43.conf</p>
<div class="highlight"><pre><span></span><code>sudo mv ~/Descargas/isard-vpn.conf /etc/wireguard/docente43.conf
</code></pre></div>
<p>Levantamos la vpn:</p>
<div class="highlight"><pre><span></span><code>sudo wg-quick up docente43
</code></pre></div>
<p>En la card aparece la ip una vez el escritorio ha arrancado:</p>
<p><a class="glightbox" href="../images/mikrotik2.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240430164158411" src="../images/mikrotik2.png" /></a></p>
<p>Verificamos que le podemos hacer ping desde nuestro equipo:</p>
<div class="highlight"><pre><span></span><code>➜  ~ ping -c 1 10.2.239.24
PING 10.2.239.24 (10.2.239.24) 56(84) bytes of data.
64 bytes from 10.2.239.24: icmp_seq=1 ttl=63 time=23.8 ms

--- 10.2.239.24 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 23.769/23.769/23.769/0.000 ms
</code></pre></div>
<p>Ahora para poder conectarnos por ssh hemos de hacer algunas configuraciones en el escritorio. Nos conectamos con el visor spice o vnc y hacemos varias operaciones:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># cambiar el teclado a español</span>
setkmap<span class="w"> </span>es

<span class="c1"># quitamos reglas de firewall y ponermos política por defecto ACCEPT</span>
<span class="c1"># iptables -X: Elimina todas las cadenas de reglas personalizadas menos las predeterminadas.</span>
<span class="c1"># iptables -F: Borra todas las reglas dentro de todas las cadenas</span>
<span class="c1"># iptables -P INPUT ACCEPT: Establece la política predeterminada para la cadena INPUT.</span>
<span class="c1"># Todas las conexiones entrantes serán aceptadas por defecto</span>
iptables<span class="w"> </span>-X<span class="p">;</span><span class="w"> </span>iptables<span class="w"> </span>-F<span class="p">;</span><span class="w"> </span>iptables<span class="w"> </span>-P<span class="w"> </span>INPUT<span class="w"> </span>ACCEPT
</code></pre></div>
<p>verificamos que no quedan reglas de firewall y que el servicio de ssh está escuchando:</p>
<div class="highlight"><pre><span></span><code>iptables-save
ss<span class="w"> </span>-tlnp
</code></pre></div>
<p>La salida esperada de estos comandos es:
<div class="highlight"><pre><span></span><code>[root@sysrescue ~]# iptables-save
*filter
:INPUT ACCEPT [78:13518]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [172:18618]
:LOGDROP - [0:0]
COMMIT

[root@sysrescue ~]# ss -tlnp
State        Recv-Q       Send-Q             Local Address:Port               Peer Address:Port       Process                              
LISTEN       0            128                      0.0.0.0:22                      0.0.0.0:*           users:((&quot;sshd&quot;,pid=375,fd=3))       
LISTEN       0            128                         [::]:22                         [::]:*           users:((&quot;sshd&quot;,pid=375,fd=4)) 
</code></pre></div></p>
<p>cambiamos el password de root:
<div class="highlight"><pre><span></span><code>passwd
</code></pre></div></p>
<p>Ya deberíamos poder entrar por ssh al escritorio desde nuestra terminal:</p>
<div class="highlight"><pre><span></span><code>ssh root@10.2.239.24
</code></pre></div>
<p>Una vez dentro del escritorio podemos ir copiando y pegando órdenes.</p>
<p>Vamos a la web de mikrotik al apartado de descargas donde están todas las versiones: </p>
<p>https://mikrotik.com/download/archive</p>
<p>Buscamos la imagen estable más reciente, en su vesión <strong>img</strong>,  chr-VERSION-img.zip, actualmente la última estable es:  <strong>chr-7.14.3.img.zip</strong>.</p>
<p>La url de descarga es: https://download.mikrotik.com/routeros/7.14.3/chr-7.14.3.img.zip</p>
<p>y en la misma web de descargas nos indican que la firma sha256 de este fichero es:
064d82932c305c8fb8f681a526b2f159133684f74ca493560cfabdc00798d912</p>
<p>Para descargar la imagen observamos que disponemos de 4GB en el directorio temporal
<div class="highlight"><pre><span></span><code>[root@sysrescue ~]# df -h /tmp
Filesystem      Size  Used Avail Use% Mounted on
tmpfs           3.9G     0  3.9G   0% /tmp
</code></pre></div></p>
<p>Podemos descargar el fichero en este directorio y verificar la firma:</p>
<div class="highlight"><pre><span></span><code>wget -O /tmp/routeros.img.zip https://download.mikrotik.com/routeros/7.14.3/chr-7.14.3.img.zip
sha256sum /tmp/routeros.img.zip
</code></pre></div>
<p>Una vez verificada que la firma es válida, procedemos a descomprimir el contenido:
<div class="highlight"><pre><span></span><code>unzip -d /tmp/ /tmp/routeros.img.zip
</code></pre></div></p>
<p>Que descomprime un fichero con una imagen de disco de 128M:
<div class="highlight"><pre><span></span><code>[root@sysrescue /tmp]# ls -lh /tmp/*.img
-rw-r--r-- 1 root root 128M Apr 17 13:50 /tmp/chr-7.14.3.img
</code></pre></div></p>
<p>Ahora hemos de clonar esta imagen en el disco virtual /dev/vda
<div class="highlight"><pre><span></span><code>[root@sysrescue /tmp]# hdparm /dev/vda

/dev/vda:
 readonly      =  0 (off)
 readahead     = 256 (on)
 geometry      = 41610/16/63, sectors = 41943040, start = 0
</code></pre></div></p>
<p>Para ello usaremos la herramienta dd:
<div class="highlight"><pre><span></span><code># if: input file, en este caso el fichero de imagen de disco
# of: output file, en este caso es un dispositivo de disco virtual
# bs: tamaño de bloque de lectura y escritura, para ficheros grandes agiliza la escritura que si no por defecto se hace en bloques pequeños
# status: le indica que queremos ir viendo el progreso, útil si el fichero fuese muy grande, en nuestro caso será casi instantáneo

dd if=/tmp/chr-7.14.3.img of=/dev/vda bs=1M status=progress
</code></pre></div></p>
<p>Ahora podemos apagar el escritorio virtual con:
<div class="highlight"><pre><span></span><code>poweroff
</code></pre></div></p>
<p>Ahora podemos editar el escritorio, y prepararlo para crear una plantilla. Al editar:
- vcpus: podemos dejar las <strong>dos vcpus</strong>
- reducir la memoria a <strong>1GB</strong>
- cambiar <strong>boot a Disco Duro</strong>
- redes en orden, podemos añadir más o cambiar en función de lo que deseemos que quede fijado en la plantilla, luego los alumnos la pueden cambiar al crear el escritorio. Es habitual que la primera interface de salida a internet (<strong>default</strong>), en nuestro caso la segunda dará acceso a la red de vpn (<strong>wireguardVPN</strong>) y la tercera interface estará conectada a la red personal (<strong>Personal1</strong>)
- <strong>quitar iso</strong> de system rescue cd
- subimos una imagen como logo de mikrotik y la seleccionamos</p>
<p>Una vez hechos los cambios de hardware convertimos el escritorio en plantilla, de nombre: <strong>routeros 7.14</strong></p>
<p>Ahora ya podemos seguir trabajando con nuestro escritorio, que ahora estará basado en esta nueva plantilla.</p>
<h3 id="config-incial-mikrotik">Config incial mikrotik<a class="headerlink" href="#config-incial-mikrotik" title="Permanent link">&para;</a></h3>
<p>Una vez arranca el escritorio, habrá pillado la imagen de mikrotik para arrancar y nos dará acceso a la línea de órdenes de mikrotik, como si nos hubiésemos conectado por telnet o puerto serie la primera vez al router. Nos ha de aparecer una pantalla como esta:</p>
<p><a class="glightbox" href="../images/image-20240501082409866.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240501082409866" src="../images/image-20240501082409866.png" /></a></p>
<p>Entramos con admin / sin password</p>
<p>Lo primero que nos pide es que le demos un password, en este caso le hemos puesto la contrasñea habitual de nuestras plantillas "pirineus". Y accedmos al prompt de mikrotik:</p>
<p><a class="glightbox" href="../images/image-20240501082609486.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240501082609486" src="../images/image-20240501082609486.png" /></a></p>
<p>Podemos verificar que tiene salida a internet:</p>
<p><a class="glightbox" href="../images/image-20240501082744520.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240501082744520" src="../images/image-20240501082744520.png" /></a></p>
<p>Lo primero que nos interesa es poder trabajar más cómodamente, con una terminal donde podamos hacer copy/paste y no con un visor que al no tener interface gráfica no me permite usar el portapapeles entre el escritorio virtual y nuestro equipo.</p>
<p>Para eso habremos de habilitar la interface de wireguard vpn. Habremos de decirle al router que queremos que en la segunda interface obtenga una ip por dhcp. La red de wireguard-VPN ofrece una ip dinámica pero sin gateway por defecto. </p>
<p>Revisamos que las interfaces están activas y vemos el nombre que tienen:</p>
<div class="highlight"><pre><span></span><code>interface print
</code></pre></div>
<p><a class="glightbox" href="../images/image-20240501083629074.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240501083629074" src="../images/image-20240501083629074.png" /></a></p>
<p>La segunda interface se llama <strong>ether2</strong>.</p>
<p>Pasamos a configurar que obtenga una ip por dhcp, y esperamos hasta que obtenga ip:</p>
<div class="highlight"><pre><span></span><code>ip dhcp-client add interface=ether2
</code></pre></div>
<p><a class="glightbox" href="../images/image-20240501083906582.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240501083906582" src="../images/image-20240501083906582.png" /></a></p>
<p>Revisamos que las ips y las rutas son correctas. Ha añadido reglas de routing para que podamos acceder desde nuestro equipo a través de la vpn personal:</p>
<div class="highlight"><pre><span></span><code>ip address print
ip router print
</code></pre></div>
<p><a class="glightbox" href="../images/image-20240501084035256.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240501084035256" src="../images/image-20240501084035256.png" /></a></p>
<p>En este caso la ip que me se ha obtenido en la interface ether2 es 10.2.239.24</p>
<p>Ya deberíamos poder hacer ping y acceder por ssh desde nuestro equipo. Al conectar por ssh como anteriormente nos conectamos por esa misma ip al system rescue cd, es probable que nos diga que hay un conflicto de claves en ~/.ssh/known_hosts que podemos resolver borrando la clave anterior con:</p>
<div class="highlight"><pre><span></span><code>ssh-keygen -f ~/.ssh/known_hosts -R &quot;LA_IP_DEL_ESCRITORIO_EN_LA_RED_DE_WIREGUARD_VPN&quot;
</code></pre></div>
<p>Para acceder lo haríamos lo hemos de hacer con el usuario admin</p>
<div class="highlight"><pre><span></span><code>ssh admin@LA_IP_DEL_ESCRITORIO_EN_LA_RED_DE_WIREGUARD_VPN
</code></pre></div>
<p>El resultado debería ser algo similar a:</p>
<div class="highlight"><pre><span></span><code>➜  ~ ssh admin@10.2.239.24                              
The authenticity of host &#39;10.2.239.24 (10.2.239.24)&#39; can&#39;t be established.
RSA key fingerprint is SHA256:+xpN6EIEw3LTfCzrmH7VWOwGN1cRqCH4RhaB8LkATEs.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added &#39;10.2.239.24&#39; (RSA) to the list of known hosts.
admin@10.2.239.24&#39;s password: 


  MMM      MMM       KKK                          TTTTTTTTTTT      KKK
  MMMM    MMMM       KKK                          TTTTTTTTTTT      KKK
  MMM MMMM MMM  III  KKK  KKK  RRRRRR     OOOOOO      TTT     III  KKK  KKK
  MMM  MM  MMM  III  KKKKK     RRR  RRR  OOO  OOO     TTT     III  KKKKK
  MMM      MMM  III  KKK KKK   RRRRRR    OOO  OOO     TTT     III  KKK KKK
  MMM      MMM  III  KKK  KKK  RRR  RRR   OOOOOO      TTT     III  KKK  KKK

  MikroTik RouterOS 7.14.3 (c) 1999-2024       https://www.mikrotik.com/

Press F1 for help

[admin@MikroTik] &gt; 
</code></pre></div>
<p>Y ya tenemos acceso a wireguard por la línea de comandos</p>
<h3 id="configurar-red-interna-con-servidor-de-dhcp-y-vpn">Configurar red interna con servidor de dhcp y vpn<a class="headerlink" href="#configurar-red-interna-con-servidor-de-dhcp-y-vpn" title="Permanent link">&para;</a></h3>
<p>Ahora hemos de configurar una red interna donde queremos que el router haga de servidor dhcp y enmascare la salida a internet.</p>
<p>Al haber accedido vía ssh ya podremos copiar y pegar comandos sin problemas. Los pasos serían:</p>
<ul>
<li>
<p>agrupamos las interfaces en WAN Y LAN</p>
</li>
<li>
<p>asignar ip fija a la interface ether3</p>
</li>
<li>
<p>crear pool de ips</p>
</li>
<li>
<p>crear servidor dhcp con este pool de ips</p>
</li>
<li>
<p>añadir configuración al servidor dhcp que hemos creao</p>
</li>
<li>
<p>crear servidor dns que redirija peticiones a servidor dns externo</p>
</li>
<li>
<p>configurar firewall para que enmascare la salida a internet desde la red interna</p>
</li>
<li>
<p>segurizar que solamente desde la lan se permitan conexiones entrarntes por defecto</p>
</li>
<li>
<p>cambiamos el nombre al router</p>
</li>
<li>
<p>ajusamos reloj y zona horaria</p>
</li>
<li>
<p>Renombramos las interfaces:</p>
</li>
<li>
<p>ether1: <strong>inet</strong> (internet red default) </p>
</li>
<li>ether2: <strong>vpnisard</strong> (red wireguard vpn para conectarnos con nuestro fichero de vpn del usuario de isard)</li>
<li>ether3: <strong>lan1</strong> (red personal 1)</li>
</ul>
<div class="highlight"><pre><span></span><code># INTERFACES LIST
/interface list
add comment=defconf name=WAN
add comment=defconf name=LAN

/interface list member
add comment=defconf interface=ether3 list=LAN
add comment=defconf interface=ether2 list=LAN
add comment=defconf interface=ether1 list=WAN

/ip neighbor discovery-settings
set discover-interface-list=LAN

# DIRECCION IP INTERNA
/ip address
add address=192.168.88.1/24 comment=defconf interface=ether3 network=192.168.88.0

# SERVIDOR DHCP
/ip pool
add name=default-dhcp ranges=192.168.88.100-192.168.88.254
/ip dhcp-server
add address-pool=default-dhcp interface=ether3 name=defconf
/ip dhcp-server network
add address=192.168.88.0/24 comment=defconf gateway=192.168.88.1

# SERVIDOR DNS
/ip dns
set allow-remote-requests=yes servers=8.8.8.8
/ip dns static
add address=192.168.88.1 comment=defconf name=router.lan

# FIREWALL MASQUERADE
/ip firewall nat
add action=masquerade chain=srcnat comment=&quot;defconf: masquerade&quot; ipsec-policy=out,none \
    out-interface-list=WAN

# FIREWALL
/ip firewall filter
add action=accept chain=input comment=&quot;defconf: accept established,related,untracked&quot; \
    connection-state=established,related,untracked
add action=drop chain=input comment=&quot;defconf: drop invalid&quot; connection-state=invalid
add action=accept chain=input comment=&quot;defconf: accept ICMP&quot; protocol=icmp
add action=accept chain=input comment=&quot;defconf: accept to local loopback (for CAPsMAN)&quot; dst-address=\
    127.0.0.1
add action=drop chain=input comment=&quot;defconf: drop all not coming from LAN&quot; in-interface-list=!LAN
add action=accept chain=forward comment=&quot;defconf: accept in ipsec policy&quot; ipsec-policy=in,ipsec
add action=accept chain=forward comment=&quot;defconf: accept out ipsec policy&quot; ipsec-policy=out,ipsec
add action=fasttrack-connection chain=forward comment=&quot;defconf: fasttrack&quot; connection-state=\
    established,related hw-offload=yes
add action=accept chain=forward comment=&quot;defconf: accept established,related, untracked&quot; \
    connection-state=established,related,untracked
add action=drop chain=forward comment=&quot;defconf: drop invalid&quot; connection-state=invalid
add action=drop chain=forward comment=&quot;defconf: drop all from WAN not DSTNATed&quot; connection-nat-state=\
    !dstnat connection-state=new in-interface-list=WAN

# CAMBIAMOS EL NOMBRE AL ROUTER

/system identity
set name=mkt_isard

# Asignamos la zona horaria y sincronizamos correctamente
/system clock
set time-zone-name=Europe/Madrid
/system ntp client
set enabled=yes
/system ntp client servers
add address=213.251.52.234
add address=158.227.98.15

/system clock print

# RENOMBRAR INTERFACES
/interface ethernet
set [ find default-name=ether1 ] disable-running-check=no name=inet
set [ find default-name=ether3 ] disable-running-check=no name=lan1
set [ find default-name=ether2 ] disable-running-check=no name=vpnisard
</code></pre></div>
<p>Y finalmente hacemos un backup de la configuración actual por si la queremos recuperar:</p>
<div class="highlight"><pre><span></span><code>/system backup save name=defconf
</code></pre></div>
<p>Podemos apagar el router desde dentro: </p>
<div class="highlight"><pre><span></span><code>/system/shutdown
</code></pre></div>
<h3 id="preparar-la-configuracion-del-router-como-plantilla">Preparar la configuración del router como plantilla<a class="headerlink" href="#preparar-la-configuracion-del-router-como-plantilla" title="Permanent link">&para;</a></h3>
<p>Si queremos que esta configuración sirva como plantilla no es tan sencillo como si se tratase de un sistema operativo habitual de windows o linux. RouterOS retiene las direcciones MAC asociadas a las tarjetas en la configuración y eso impide que lea bien la configuración al clonar el disco con diferentes MAC. </p>
<p>Cada escritorio derivado de una plantilla se crea con una MAC distinta en cada tarjeta, con lo que hay que realizar un poco más de trabajo para dejar lista la plantilla.</p>
<p>Guardamos la configuración en modo lista de órdenes con la instrucción </p>
<div class="highlight"><pre><span></span><code>/export file=inicial
</code></pre></div>
<p>Copiamos el fichero en local y añadimos una línea inicial para eliminar la configuración de cliente por dhcp que viene en la config por defecto</p>
<p>Desde nuestro PC o desde el cliente de vitalinux:</p>
<div class="highlight"><pre><span></span><code>scp admin@IP_DEL_ROUTER:/inicial.rsc ~/tmp/inicial.rsc
</code></pre></div>
<p>Modificamos el fichero inicial.rsc añadiendo <strong>remove 0</strong> en la parte de configuración del cliente de dhcp, ya que en al borrar la configuración crea un cliente dhcp por defecto. En el fichero que nos hemos descargado del router tenemos:</p>
<div class="highlight"><pre><span></span><code>/ip dhcp-client
add interface=inet
add interface=vpnisard
</code></pre></div>
<p>Y esa parte se ha de modificar por:</p>
<div class="highlight"><pre><span></span><code>/ip dhcp-client
remove 0
add interface=inet
add interface=vpnisard
</code></pre></div>
<p>Ahora sólo nos queda volver a subir el fichero al router y sobreescribirlo:</p>
<div class="highlight"><pre><span></span><code>scp ~/tmp/inicial.rsc admin@IP_DEL_ROUTER:/inicial.rsc
</code></pre></div>
<p>Podemos ver el listado de ficheros y verificar que el fichero ha subido adecuadamente mirando el CREATION-TIME </p>
<div class="highlight"><pre><span></span><code>/file/print
</code></pre></div>
<p>Finalmente sólo nos queda decirle al router que reset de la configuración, que cuando inicie por primera vez importe las órdenes del fichero inicial.rsc y verificar que ha pillado bien la configuración de nuevo:</p>
<div class="highlight"><pre><span></span><code>/system/reset-configuration no-defaults=yes run-after-reset=inicial.rsc
</code></pre></div>
<p>Reiniciará como si fuera la primera vez, hemos de poner usuario admin / sin password.</p>
<p>Verificamos que no hay mensajes de error y que la configuración parece correcta</p>
<div class="highlight"><pre><span></span><code>/log/print
/export
</code></pre></div>
<p>y ahora hemos de repetir el reset de la configuración pero que ahora se apague para que podamos clonar el estado actual del disco duro del router en una plantilla.</p>
<div class="highlight"><pre><span></span><code>/system/reset-configuration no-defaults=yes run-after-reset=inicial.rsc shutdown=yes
</code></pre></div>
<p>El escritorio se apaga. Ahora es cuando hemos de crear la plantilla de nombre <strong>router 7.14 inet-vpn-lan</strong></p>
<p>Para verificar que todo va bien hemos de crear un nuevo escritorio de prueba basado en esta plantilla, no nos vale con el actual que conservará las mismas MAC, y ver que la configuración ha funcionado.</p>
<p>Creamos un escritorio de nombre "prueba" basado en la plantilla "router 7.14 inet-vpn-lan" y verificamos que todo funciona correctamente. Si es así ya podemos usar esta plantilla en nuestras clases.</p>
<h3 id="cliente-en-red-interna">Cliente en red interna<a class="headerlink" href="#cliente-en-red-interna" title="Permanent link">&para;</a></h3>
<p>Creamos un escritorio cliente:</p>
<ul>
<li>plantilla: vitalinux, ubuntu, windows</li>
<li>redes: <strong>sólo una red personal1</strong></li>
</ul>
<p>Si nos conectamos por el cliente spice podremos hacer copy/paste al escritorio</p>
<p>Por ejemplo desde dentro de <strong>vitalinux</strong> verificamos:</p>
<ul>
<li>verificar que nos ha dado <strong>ip por dhcp</strong></li>
<li>verificar que funciona el masquerade haciendo <strong>ping a 8.8.8.8</strong></li>
<li>verificar que la <strong>configuración de dns</strong> es la correcta</li>
<li>verificar que podemos hacer <strong>ping a una dirección dns</strong></li>
</ul>
<div class="highlight"><pre><span></span><code>ip -c a s ens3
ping -c 1 8.8.8.8
systemd-resolve --status ens3
ping -c 1 www.google.es
</code></pre></div>
<p>Y el resultado esperado es:</p>
<div class="highlight"><pre><span></span><code>isard@vitalinux:~/Desktop$ ip -c a s ens3
2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:75:d3:0b brd ff:ff:ff:ff:ff:ff
    inet 192.168.88.254/24 brd 192.168.88.255 scope global dynamic noprefixroute ens3
       valid_lft 1581sec preferred_lft 1581sec
    inet6 fe80::a8d3:848f:4f11:3ca8/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
isard@vitalinux:~/Desktop$ ping -c 1 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=116 time=15.0 ms

--- 8.8.8.8 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 15.017/15.017/15.017/0.000 ms
isard@vitalinux:~/Desktop$ systemd-resolve --status ens3
Link 2 (ens3)
      Current Scopes: DNS
       LLMNR setting: yes
MulticastDNS setting: no
      DNSSEC setting: no
    DNSSEC supported: no
         DNS Servers: 192.168.88.1
                      192.168.120.1
          DNS Domain: ~.
isard@vitalinux:~/Desktop$ ping -c 1 www.google.es
PING www.google.es (216.58.215.163) 56(84) bytes of data.
64 bytes from mad41s07-in-f3.1e100.net (216.58.215.163): icmp_seq=1 ttl=116 time=19.3 ms

--- www.google.es ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 19.352/19.352/19.352/0.000 ms
</code></pre></div>
<h3 id="usar-la-herramienta-con-entorno-grafico-winbox-para-configurar-la-mikrotik">Usar la herramienta con entorno gráfico winbox para configurar la mikrotik<a class="headerlink" href="#usar-la-herramienta-con-entorno-grafico-winbox-para-configurar-la-mikrotik" title="Permanent link">&para;</a></h3>
<p>Desde un cliente conectado a la lan podemos usar la herramienta winbox. Por ejemplo lo podemos hacer desde el escritorio de vitalinux. </p>
<p>Vitalinux ya lleva instalado el paquete wine, en otras distribuciones de linux hace falta instalarlo, en windows no es necesario. Wine permite arrancar ciertas aplicaciones compiladas para windows dentro de linux. </p>
<p>Podemos descargar winbox desde la web de mikrotik. Desde un terminal podemos descargarlo también:</p>
<div class="highlight"><pre><span></span><code>wget -O ~/winbox.exe https://download.mikrotik.com/routeros/winbox/3.40/winbox64.exe
</code></pre></div>
<p>Y para arrancarlo:</p>
<div class="highlight"><pre><span></span><code>wine ~/winbox.exe 
</code></pre></div>
<p>Si es la primera vez que arrancamos wine aparecen mensajes reclamando instalaciones extras podemos descartarlas porque no se necesitan para que funcione winbox. </p>
<p>Llegamos a una pantalla como esta donde podemos poner la ip del router y el password:</p>
<p><a class="glightbox" href="../images/image-20240501094443682.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="image-20240501094443682" src="../images/image-20240501094443682.png" /></a></p>
<p>Podemos descargar un icono de escritorio:</p>
<div class="highlight"><pre><span></span><code>wget -O ~/winbox_icon.png https://github.com/juanchixd/Mikrotik-linux/blob/main/icons/winbox-128x128.png?raw=true
</code></pre></div>
<p>Crear un enlace en nuestro escritorio:</p>
<div class="highlight"><pre><span></span><code>cat &lt;&lt;&#39;EOF&#39; &gt; ~/Desktop/Winbox_Mikrotik.desktop
[Desktop Entry]
Version=1.0
Encoding=UTF-8
Name=Open Desktop
Name[en]=Winbox Mikrotik
Name[es]=Winbox Mikrotik
Name[es_ES]=Winbox Mikrotik
Exec=sh -c &quot;wine /home/isard/winbox.exe&quot;
Categories=;
Type=Application
Terminal=false
Icon=/home/isard/winbox_icon.png
EOF
</code></pre></div>
<p>Copiarlo en el directorio de autostart para que se ejecute en el arranque y verificamos que lo hace con un reboot.</p>
<div class="highlight"><pre><span></span><code>cp -a ~/Desktop/Winbox_Mikrotik.desktop ~/.config/autostart/
reboot
</code></pre></div>
<p>Podemos convertir en plantilla con nombre: "cliente winbox vitalinux"</p>
<h2 id="router-linux-basadao-en-alpine-linux">Router linux basadao en alpine linux<a class="headerlink" href="#router-linux-basadao-en-alpine-linux" title="Permanent link">&para;</a></h2>
<h3 id="crear-plantilla-de-alpine-linux">Crear plantilla de alpine linux<a class="headerlink" href="#crear-plantilla-de-alpine-linux" title="Permanent link">&para;</a></h3>
<p>A partir de iso, vamos a la web de alpine y buscamos la versión standard para arquitectura x86:64. Copiamos la url y descargamos la iso en isard. En el momento de redactar esta guía la direccion de descarga era: https://dl-cdn.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-standard-3.19.1-x86_64.iso</p>
<p>Creamos escritorio basado en plantilla de hardware debian10 con 40GB de disco, 2vcpus y 1GB de memoria. Con una sola interface para crear la plantilla genérica.</p>
<p>Para instalar iniciamos como usario root y no nos pide password</p>
<p>Ejecutamos <strong>setup-alpine</strong> y configuramos todo el arranque.</p>
<p>Ahora queremos preparar un script inicial para poder poner las reglas de firewall, rutas y demás acciones que queremos hacer cuando el router arranque. </p>
<p>Hacemos un primer script en:</p>
<div class="highlight"><pre><span></span><code>touch /usr/local/bin/startup_script.sh
chmod u+x /usr/local/bin/startup_script.sh
</code></pre></div>
<p>El contenido del script puede ser;</p>
<div class="highlight"><pre><span></span><code>#!/bin/bash
ip a s &gt;&gt; /tmp/log_ip.txt
</code></pre></div>
<p>Creamos el fichero de servicio:</p>
<div class="highlight"><pre><span></span><code>touch /etc/init.d/router
chmod u+x /etc/init.d/router
</code></pre></div>
<p>El contenido del fichero de servico:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/sbin/openrc-run</span>

depend<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>after<span class="w"> </span>sshd
<span class="o">}</span>

start<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>ebegin<span class="w"> </span><span class="s2">&quot;router starting&quot;</span>
<span class="w">    </span>/usr/local/bin/startup_script.sh
<span class="w">    </span>eend<span class="w"> </span><span class="nv">$?</span>
<span class="o">}</span>
</code></pre></div>
<p>Activamos el servicio:</p>
<div class="highlight"><pre><span></span><code>rc-update<span class="w"> </span>add<span class="w"> </span>router<span class="w"> </span>default
</code></pre></div>
<p>Activamos el bit de forwarding:</p>
<div class="highlight"><pre><span></span><code>echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf
</code></pre></div>
<p>Podemos verificar si está activo después de un reboot mirando:</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/proc/sys/net/ipv4/ip_forward
</code></pre></div>
<p>Añadimos paquetes de redes:</p>
<div class="highlight"><pre><span></span><code>apk add iptables iproute2 dnsmasq
</code></pre></div>
<p>Apagamos y creamos plantilla <strong>alpine redes v1</strong></p>
<h2 id="configuracion-de-red-en-linux">Configuración de red en linux<a class="headerlink" href="#configuracion-de-red-en-linux" title="Permanent link">&para;</a></h2>
<p>Añadimos las redes de wireguard vpn y personal 1:</p>
<ul>
<li>eth0: default salida a internet (la ip la gestiona el sistema operativo)</li>
<li>eth1: wireguard-vpn</li>
<li>eth2: personal1</li>
</ul>
<p>Lo primero es poder configurar desde un terminal, para eso levantamos la interface eth1 y pedimos ip por dhcp para poderle entrar por ssh</p>
<div class="highlight"><pre><span></span><code>ip link set eth1 up
udhcpc -i eth1
ip r a 10.0.0.0/14 via 10.2.0.1
</code></pre></div>
<p>Ahora ya nos podemos conectar como usuario isard a la ip de la red de wireguard que tengamos (10.2.X.Y)</p>
<div class="highlight"><pre><span></span><code>ssh isard@IP_DE_INTERFACE_WIREGUARD
</code></pre></div>
<p>También podemos configurar /etc/ssh/sshd_config para permitir entrar como root, modificando la línea:</p>
<div class="highlight"><pre><span></span><code>PermitRootLogin yes
</code></pre></div>
<p>Editamos el script <strong>/usr/local/bin/startup_script.sh</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># CONFIGURAR IP VPN DE USUARIO ISARD</span>
<span class="c1"># añadiendo la ruta que el udhcpc no la añade por defecto</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>eth1<span class="w"> </span>name<span class="w"> </span>vpnisard
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>vpnisard<span class="w"> </span>up
udhcpc<span class="w"> </span>-i<span class="w"> </span>vpnisard
ip<span class="w"> </span>r<span class="w"> </span>a<span class="w"> </span><span class="m">10</span>.0.0.0/14<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.2.0.1

<span class="c1"># CONFIGURAR IP LAN1</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>eth2<span class="w"> </span>name<span class="w"> </span>lan1
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>lan1<span class="w"> </span>up
ip<span class="w"> </span>a<span class="w"> </span>a<span class="w"> </span><span class="m">192</span>.168.88.2/24<span class="w"> </span>dev<span class="w"> </span>lan1

<span class="c1"># SERVIDOR DHCP</span>
<span class="c1"># creamos fichero de configuración</span>
cat<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39; &gt; /etc/dnsmasq_router.conf</span>
<span class="s">interface=lan1</span>
<span class="s">dhcp-range=192.168.88.20,192.168.88.99,255.255.255.0,24h</span>
<span class="s">dhcp-option=3,192.168.88.2</span>
<span class="s">dhcp-option=6,8.8.8.8,1.1.1.1</span>
<span class="s">EOF</span>
<span class="c1">#lanzamos el servidor dnsmasq</span>
dnsmasq<span class="w"> </span>--conf-file<span class="o">=</span>/etc/dnsmasq_router.conf

<span class="c1"># NAT MASQUERADE</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-o<span class="w"> </span>eth0<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</code></pre></div>
<p>Una vez verificado con un cliente que todo funciona adecuadamente creamos plantilla router-mikrotik</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 <a href="http://www.isardvdi.com">IsardVDI</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.follow"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>